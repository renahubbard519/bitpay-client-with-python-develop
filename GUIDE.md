# Using the BitPay Python client

This SDK provides a convenient abstraction of BitPay's [cryptographically-secure API](https://bitpay.com/api) and allows payment gateway developers to focus on payment flow/e-commerce integration rather than on the specific details of client-server interaction using the API.  This SDK optionally provides the flexibility for developers to have control over important details, including the handling of private keys needed for client-server communication.

It also implements BitPay's remote client authentication and authorization strategy.  No private or shared-secret information is ever transmitted over the wire.

## Dependencies

You must have a BitPay merchant account to use this SDK.  It's free to [sign-up for a BitPay merchant account](https://bitpay.com/start).

If you need a test account, please visit https://test.bitpay.com/dashboard/signup and register for a BitPay merchant test account. Please fill in all questions, so you get a fully working test account.
If you are looking for a testnet bitcoin wallet to test with, please visit https://bitpay.com/wallet and
create a new wallet.
If you need testnet bitcoin please visit a testnet faucet, e.g. https://testnet.coinfaucet.eu/en/ or http://tpfaucet.appspot.com/

For more information about testing, please see https://bitpay.com/docs/testing

## Handling your client private key

Each client paired with the BitPay server requires a ECDSA key.  This key provides the security mechanism for all client interaction with the BitPay server. The public key is used to derive the specific client identity that is displayed on your BitPay dashboard.  The public key is also used for securely signing all API requests from the client.  See the [BitPay API](https://bitpay.com/api) for more information.

The private key should be stored in the client environment such that it cannot be compromised.  If your private key is compromised you should revoke the compromised client identity from the BitPay server and re-pair your client, see the [API tokens](https://bitpay.com/api-tokens) for more information.

**There are two ways to generate the configuration file required to load the SDK:**

* Using the [BitPaySetup Script]() helps to generate the private key, as well as a environment file formatted in JSON which contains all configuration requirements, that should be stored in the client local file system. It is not recommended to transmit the private key over any public or unsecure networks.
  
  Once the BitPaySetup Script has run and generated the Json correctly, read the console output and follow the instructions in order to pair your new tokens.
  This method would also allow you to generate the Private Key as plain text which you can securely store in case you are using cloud services.

* Or using the [BitPay.Net Setup utility]() on a Windows machine, helps to generate the private key, as well as a environment file formatted in JSON which contains all configuration requirements, that should be stored in the client local file system. It is not recommended to transmit the private key over any public or unsecure networks.
  
  Follow the guide [BitPay.Net Setup utility guide]() that assist you to create the environment file which you will be able to modify it, either manually or by using the BitPay.Net Setup utility, later on by asking you to provide the path to your existing JSON file.

The environment file can be either generated by the BitPay.Net Setup utility or created manually by copying the following Json structure:

```python
{
  "BitPayConfiguration": {
    "Environment": "",
    "EnvConfig": {
      "Test": {
        "PrivateKeyPath": "",
        "PrivateKey": "",
        "ApiTokens": {
          "pos": "",
          "merchant": "",
          "payout": ""
        }
      },
      "Prod": {
        "PrivateKeyPath": "",
        "PrivateKey": "",
        "ApiTokens": {
          "pos": "",
          "merchant": "",
          "payout": ""
        }
      }
    }
  }
}
```

## Getting Started

### Initializing your BitPay client

Once you have the environment file (JSON previously generated) you can initialize the client in two ways:

```python
from bitpay_sdk.client import Client

bitpay = Client(config_file_path)
```

```python
from bitpay_sdk.client import Client

bitpay = Client(None,environment, private_key_path, tokens)
```


## Pair your client with BitPay

Your client must be paired with the BitPay server. The pairing initializes authentication and authorization for your client to communicate with BitPay for your specific merchant account.

Pairing is accomplished by having the BitPay.Net Setup utility request a pairing code from the BitPay server.
Meanwhile a new pairing code is generated, the BitPay.Net Setup utility will ask you to activate it in your BitPay account. It will also store the paired token in the environment file.

The pairing code is then entered into the BitPay merchant dashboard for the desired merchant.  Your interactive authentication at https://bitpay.com/login provides the authentication needed to create finalize the client-server pairing request.

## Create an invoice

`POST` 

**Facades**  `pos` `merchant`

Creating Invoices are time-sensitive payment requests addressed to specific buyers. An invoice has a fixed price, typically denominated in fiat currency. It also has an equivalent price in the supported cryptocurrencies, calculated by BitPay, at a locked exchange rate with an expiration time of 15 minutes. 

### HTTP Request

**Headers**
| Fields | Description | Presence
| ------ | ------ | ------ |
|  X-Accept-Version  | must be set to `2.0.0` for requests to the BitPay API  | **Mandatory** |
| Content-Type | must be set to `application/json` for requests to the BitPay API | **Mandatory** | 
|  X-Identity  | the hexadecimal public key generated from the client private key. This header is required when using tokens with higher privileges (merchant facade). When using standard pos facade token directly from the BitPay dashboard (with "Require Authentication" disabled), this header is not needed.  | C |
| X-Signature | header is the ECDSA signature of the full request URL concatenated with the request body, signed with your private key. This header is required when using tokens with higher privileges (merchant facade). When using standard pos facade token directly from the BitPay dashboard (with "Require Authentication" disabled), this header is not needed. | C |

**Body**
| Name | Description |Type | Presence|
| ------ | ------ | ----- |------ |
|  token  | The API token can be retrieved from the dashboard (limited to pos facade) or using the Tokens resource to get access to the merchant facade. This is described in the section Request an API token).| `string` | **Mandatory** |
| price | Fixed price amount for the checkout, in the "currency" of the invoice object. | `number` | **Mandatory** |
| currency | ISO 4217 3-character currency code. This is the currency associated with the price field, supported currencies are available via the Currencies resource.| `string` | **Mandatory** |
| orderId | Can be used by the merchant to assign their own internal Id to an invoice. If used, there should be a direct match between an orderId and an invoice id. | `string` | Optional |
| itemDesc | Invoice description - will be added as a line item on the BitPay checkout page, under the merchant name. | `string` | Optional |
| itemCode | "bitcoindonation" for donations, otherwise do not include the field in the request. | `string` | Optional |
| notificationEmail | Merchant email address for notification of invoice status change. It is also possible to configure this email via the account setting on the BitPay dashboard or disable the email notification| `string` | Optional |
| notificationURL | URL to which BitPay sends webhook notifications. HTTPS is mandatory. | `string` | Optional |
| redirectURL | The shopper will be redirected to this URL when clicking on the Return button after a successful payment or when clicking on the Close button if a separate closeURL is not specified. Be sure to include "http://" or "https://" in the url. | `string` | Optional |
| closeURL | URL to redirect if the shopper does not pay the invoice and click on the Close button instead. Be sure to include "http://" or "https://" in the url. | `string` | Optional |
| autoRedirect | Set to false by default, merchant can setup automatic redirect to their website by setting this parameter to true. This will applied to the following scenarios:When the invoice is paid, it automatically redirects the shopper to the redirectURL indicated When the invoice expires, it automatically redirects the shopper to the closeURL if specified and to the redirectURL otherwiseNote: If automatic redirect is enabled, redirectURL becomes a mandatory invoice parameters.| `boolean` | Optional |
| posData | A passthru variable provided by the merchant during invoice creation and designed to be used by the merchant to correlate the invoice with an order or other object in their system. This passthru variable can be a serialized object, e.g.: "posData": "\"{ \"ref\" : 711454, \"item\" : \"test_item\" }\"" | `string` | Optional |
| transactionSpeed | This is a risk mitigation parameter for the merchant to configure how they want to fulfill orders depending on the number of block confirmations for the transaction made by the consumer on the selected cryptocurrency. | `string` | Optional |
| fullNotifications | This parameter is set to true by default, meaning all standard notifications are being sent for a payment made to an invoice. If you decide to set it to false instead, only 1 webhook will be sent for each invoice paid by the consumer. This webhook will be for the "confirmed" or "complete" invoice status, depending on the transactionSpeed selected. | `boolean` | Optional |
| extendedNotifications | Allows merchants to get access to additional webhooks. For instance when an invoice expires without receiving a payment or when it is refunded. If set to true, then fullNotifications is automatically set to true. When using the extendedNotifications parameter, the webhook also have a payload slightly different from the standard webhooks. | `boolean` | Optional |
| physical | Indicates whether items are physical goods. Alternatives include digital goods and services. | `boolean` | Optional |
| buyer | Allows merchant to pass buyer related information in the invoice object | ` object ` | Optional |
| paymentCurrencies | Allow the merchant to select the cryptocurrencies available as payment option on the BitPay invoice. Possible values are currently "BTC", "BCH", "ETH", "GUSD", "PAX", "BUSD", "USDC", "XRP", "DOGE", "DAI" and "WBTC". For instance "paymentCurrencies": ["BTC"] will create an invoice with only XRP available as transaction currency, thus bypassing the currency selection step on the invoice. | `array` | Optional |
| jsonPayProRequired | If set to true, this means that the invoice will only accept payments from wallets which have implemented the BitPay JSON Payment Protocol | `boolean` | Optional |
```python
// Setting mandatory parameters in invoice i.e price and currency.
Invoice invoice = new Invoice(100.0, "USD");

// Setting invoice optional parameters
invoice.setOrderId("98e572ea-910e-415d-b6de-65f5090680f6");
invoice.setFullNotifications(true);
invoice.setExtendedNotifications(true);
invoice.setTransactionSpeed("medium");
invoice.setNotificationURL("https://hookbin.com/lJnJg9WW7MtG9GZlPVdj");
invoice.setRedirectURL("https://hookbin.com/lJnJg9WW7MtG9GZlPVdj");
invoice.setPosData("98e572ea35hj356xft8y8cgh56h5090680f6");
invoice.setItemDesc("Ab tempora sed ut.");
invoice.setNotificationEmail("");

// Creating Invoice
invoice = Invoice(2.16, "eur")
invoice.set_order_id("98e572ea-910e-415d-b6de-65f5090680f6")
invoice.set_full_notifications(True)
invoice.set_extended_notifications(True)
invoice.set_transaction_speed("medium")
invoice.set_notification_url("https://hookbin.com/lJnJg9WW7MtG9GZlPVdj")
invoice.set_redirect_url("https://hookbin.com/lJnJg9WW7MtG9GZlPVdj")
invoice.set_pos_data("98e572ea35hj356xft8y8cgh56h5090680f6")
invoice.set_item_desc("Ab tempora sed ut.")

basic_invoice = bitpay.create_invoice(invoice)
```

### Create an invoice (extended)

You can add optional attributes to the invoice.  Attributes that are not set are ignored or given default values.
**Body**
| Name | Description | Type | Presence |
| --- | --- | :---: | :---: |
| `buyer` | Allows merchant to pass buyer related information in the invoice object | `object` | Optional |
| &rarr; `name` | Buyer's name | `string` | Optional |
| &rarr; `address1` | Buyer's address | `string` | Optional |
| &rarr; `address2` | Buyer's appartment or suite number | `string` | Optional |
| &rarr; `locality` | Buyer's city or locality | `string` | Optional |
| &rarr; `region` | Buyer's state or province | `string` | Optional |
| &rarr; `postalCode` | Buyer's Zip or Postal Code | `string` | Optional |
| &rarr; `country` | Buyer's Country code. Format ISO 3166-1 alpha-2 | `string` | Optional |
| &rarr; `email` | Buyer's email address. If provided during invoice creation, this will bypass the email prompt for the consumer when opening the invoice. | `string` | Optional |
| &rarr; `phone` | Buyer's phone number | `string` | Optional |
| &rarr; `notify` | Indicates whether a BitPay email confirmation should be sent to the buyer once he has paid the invoice | `boolean` | Optional |

```python
invoice = Invoice(2.16, "eur")
invoice.set_order_id("98e572ea-910e-415d-b6de-65f5090680f6")
invoice.set_full_notifications(True)
invoice.set_extended_notifications(True)
invoice.set_transaction_speed("medium")
invoice.set_notification_url("https://hookbin.com/lJnJg9WW7MtG9GZlPVdj")
invoice.set_redirect_url("https://hookbin.com/lJnJg9WW7MtG9GZlPVdj")
invoice.set_pos_data("98e572ea35hj356xft8y8cgh56h5090680f6")
invoice.set_item_desc("Ab tempora sed ut.")

buyer = Buyer()
buyer.set_name("Bily Matthews")
buyer.set_email("sandbox@bitpay.com")
buyer.set_address1("168 General Grove")
buyer.set_address2("sandbox@bitpay.com")
buyer.set_country("AD")
buyer.set_locality("Port Horizon")
buyer.set_notify(True)
buyer.set_phone("+99477512690")
buyer.set_postal_code("KY7 1TH")
buyer.set_region("New Port")

invoice.set_buyer(buyer)

basic_invoice = bitpay.create_invoice(invoice)
```

## Retrieve an invoice

`GET`  

**Facades**  `pos` `merchant`

**HTTP Request**

**URL Parameters**

| Parameter | Description |Type | Presence|
| ------ | ------ | ----- |------ |
|  ?token=  | When fetching an invoice via the merchant or the pos facade, pass the API token as a URL parameter - the same token used to create the invoice in the first place. | `string` | **Mandatory** |

**Headers**

| Fields | Description | Presence|
| ------ | ------ | ------ |
|  X-Accept-Version  | must be set to `2.0.0` for requests to the BitPay API  | **Mandatory** |
| Content-Type | must be set to `application/json` for requests to the BitPay API | **Mandatory** | 
|  X-Identity  | the hexadecimal public key generated from the client private key. This header is required when using tokens with higher privileges (merchant facade). When using standard pos facade token directly from the BitPay dashboard (with "Require Authentication" disabled), this header is not needed.  | C |
| X-Signature | header is the ECDSA signature of the full request URL concatenated with the request body, signed with your private key. This header is required when using tokens with higher privileges (merchant facade). When using standard pos facade token directly from the BitPay dashboard (with "Require Authentication" disabled), this header is not needed. | C |

```python
retrieve_invoice = bitpay.get_invoice(basic_invoice.get_id())
```
## Update an invoice

Update an invoice with SMS or email in order to respond to a payment exception

:warning: Updating the invoice will require EITHER an SMS or E-mail, but not both.

:warning: smsCode required only when verifying SMS.

`PUT`  

**Facades**  `pos` `merchant`

**HTTP Request**

**URL Parameters**

| Parameter | Description |Type | Presence|
| ------ | ------ | ----- |------ |
|  ?token=  | When fetching an invoice via the merchant or the pos facade, pass the API token as a URL parameter - the same token used to create the invoice in the first place. | `string` | **Mandatory** |

| Name       | Description                                                                  | Type     | Presence  |
|------------|------------------------------------------------------------------------------|----------|-----------|
| buyerEmail | Email address of the buyer                                                   | `string` | :warning: |
| buyerSms   | SMS to use to process any payment exception if necessary. ex. “+13415556589” | `string` | :warning: |
| smsCode    | Verification code in order to complete the SMS verification process          | `string` | :warning: |

**Headers**

| Fields | Description | Presence|
| ------ | ------ | ------ |
|  X-Accept-Version  | must be set to `2.0.0` for requests to the BitPay API  | **Mandatory** |
| Content-Type | must be set to `application/json` for requests to the BitPay API | **Mandatory** | 
|  X-Identity  | the hexadecimal public key generated from the client private key. This header is required when using tokens with higher privileges (merchant facade). When using standard pos facade token directly from the BitPay dashboard (with "Require Authentication" disabled), this header is not needed.  | C |
| X-Signature | header is the ECDSA signature of the full request URL concatenated with the request body, signed with your private key. This header is required when using tokens with higher privileges (merchant facade). When using standard pos facade token directly from the BitPay dashboard (with "Require Authentication" disabled), this header is not needed. | C |

```java
updated_invoice = bitpay.update_invoice(retrieved_invoice.get_id(),
                                                     "sandbox@bitpay.com")
```

## Delete an invoice

:warning: Cancellation will require EITHER an SMS or E-mail to have already been set if the invoice has proceeded to the point where it may have
been paid.

`DELETE`  

**Facades**  `pos` `merchant`

**HTTP Request**

**URL Parameters**

| Parameter | Description |Type | Presence|
| ------ | ------ | ----- |------ |
|  ?token=  | When fetching an invoice via the merchant or the pos facade, pass the API token as a URL parameter - the same token used to create the invoice in the first place. | `string` | **Mandatory** |


**Headers**

| Fields           | Description                                                                                                                                                                                                                                                                                                                                              | Presence      |
|------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------|
| X-Accept-Version | must be set to `2.0.0` for requests to the BitPay API                                                                                                                                                                                                                                                                                                    | **Mandatory** |
| Content-Type     | must be set to `application/json` for requests to the BitPay API                                                                                                                                                                                                                                                                                         | **Mandatory** | 
| X-Identity       | the hexadecimal public key generated from the client private key. This header is required when using tokens with higher privileges (merchant facade). When using standard pos facade token directly from the BitPay dashboard (with "Require Authentication" disabled), this header is not needed.                                                       | C             |
| X-Signature      | header is the ECDSA signature of the full request URL concatenated with the request body, signed with your private key. This header is required when using tokens with higher privileges (merchant facade). When using standard pos facade token directly from the BitPay dashboard (with "Require Authentication" disabled), this header is not needed. | C             |

```python
cancelled_invoice = bitpay.cancel_invoice(updated_invoice.get_id())
```

## Request an invoice notification

```python
invoice_status = bitpay.request_invoice_notifications(basic_invoice.get_id())
```

See also the test package for more examples of API calls.

